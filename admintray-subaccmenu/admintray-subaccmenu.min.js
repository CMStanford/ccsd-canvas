// https://github.com/robert-carroll/ccsd-canvas/tree/master/admintray-subaccnav test
!function(){var t,l={cfg:{recursive:!0},where:'.tray-with-space-for-global-nav a:contains("All Accounts")',root:null,instance:location.host+"_subacc_tray",depth:0,stack:[],tree:[],html:"",skipd:(t=document.currentScript.getAttribute("src").split("?skipd="),2==t.length?JSON.parse(decodeURIComponent(t[1])):{})};l.list_to_tree=function(t,e){for(var a=(e=e||{}).idKey||"id",n=e.parentKey||"parent",r=e.childrenKey||"children",i={},c=0;c<t.length;c++)t[c][a]&&(i[t[c][a]]=t[c],t[c][r]=[]);for(c=0;c<t.length;c++)t[c][n]&&(i[t[c][n]]?(i[t[c][n]][r].push(t[c]),t.splice(c,1),c--):t[c][n]=0);return t},l.tree_to_html=function(t,e){var a="<ul"+(0==l.depth?' id="admin-tray-sam"':"")+">";for(var n in l.depth++,t)a+='<li data-depth="'+l.depth+'">',a+=t[n].children.length?'<a href="#" class="toggle"></a>':"",a+='<a href="/accounts/'+t[n].id+'" class="sub-acc">'+t[n].name+"</a>",t[n].children.length&&(a+=this.tree_to_html(t[n].children,t[n].parentid)),a+="</li>";return a+="</ul>",l.depth--,a},l.append=function(t){var e=$(l.where);e.length&&($("#adm-tray-subacctray")&&$("#adm-tray-subacctray").remove(),e.closest("li").after($("<li>",{id:"adm-tray-subacctray",class:$(l.where).closest("li").attr("class"),html:t})))},l.menu=function(){l.html=localStorage.getItem(l.instance);var t='<hr><input type="text" id="admin-tray-sam-search" placeholder="Search..." /><ol id="admin-tray-sam-results"></ol>'+l.html+'<a href="#" class="reload"></span>';l.append(t),$("ul#admin-tray-sam").delegate("a.toggle","click",function(){$(this).parent().children("ul").slideToggle(250)}),$("ul#admin-tray-sam").find("ul").hide(),$("#admin-tray-sam-search").on("input",function(){$("#admin-tray-sam-results").html("");var t=$.trim($(this).val()),e="^(?=.*\\b"+t.split(/\s+/).join("\\b)(?=.*\\b")+").*$",n=RegExp(e,"i");3<=t.length&&$("a.sub-acc").each(function(){if(n.test($(this).text())){var t="",e=$(this).parent("li").attr("data-depth"),a="";l.skipd[e]&&(t="li:eq("+(e-l.skipd[e])+")",a=$(this).parents(t).children("a.sub-acc").prop("outerHTML")+" > "),$("#admin-tray-sam-results").append("<li />"),$("#admin-tray-sam-results li:last").append(a+$(this).prop("outerHTML"))}})}),$("#adm-tray-subacctray a.reload").on("click",function(){confirm("This will clear and reload the menu, with any sub account changes that have been made.\nDo you want to continue?")&&(localStorage.removeItem(l.instance),l.depth=0,l.stack=[],l.tree=[],l.html="",$("li#adm-tray-subacctray").fadeOut("slow",l.init),l.append('<div class="loader"></div>'))})},l.listener=function(){$("#global_nav_accounts_link").click(function(){new MutationObserver(function(t){1==$(l.where).length&&0==$("li#adm-tray-subacctray").length&&0==$.active&&l.init(),1==$(l.where).length&&0==$("li#adm-tray-subacctray").length&&1==$.active&&l.append('<div class="loader"></div>')}).observe(document.body,{childList:!0,subtree:!0})})},l.init=function(){if(localStorage.getItem(l.instance))localStorage.getItem(l.instance)&&l.menu();else{var t=100,c=$.Deferred();!function r(i){$.ajax({method:"get",dataType:"json",url:"/api/v1/accounts/self/sub_accounts",cache:!0,data:{recursive:"true",per_page:t,page:i}}).done(function(t,e,a){for(var n in t)l.stack.push({id:parseInt(t[n].id),parentid:parseInt(t[n].parent_account_id),name:t[n].name,children:null}),!l.root&&t[n].root_account_id&&(l.root=t[n].root_account_id);-1!=a.getResponseHeader("Link").indexOf('rel="next"')?r(i+1):c.resolve()})}(1),c.then(function(){l.stack.sort(function(t,e){var a=t.name.toLowerCase(),n=e.name.toLowerCase();return a<n?-1:n<a?1:0}),l.tree=l.list_to_tree(l.stack,{idKey:"id",parentKey:"parentid",childrenKey:"children"});var t=l.tree_to_html(l.tree,l.root);l.html=localStorage.setItem(l.instance,t),l.menu()})}l.listener()},l.init()}();
